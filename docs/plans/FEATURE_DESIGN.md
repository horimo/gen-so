# GEN-SO テラリウム機能設計書

## 📋 概要

GEN-SO（言層）に「テラリウム感」を追加し、画面を眺めていて楽しくなる動的な環境要素を実装します。感情の地層が単なる表示ではなく、生きている生態系のように感じられる体験を目指します。

## 📅 実装状況

- **作成日**: 2024年12月30日
- **最終更新日**: 2024年12月30日
- **実装完了**: Phase 1-4まで完了 ✅
  - Phase 1-1.5: 全7種類の植物タイプ ✅
  - Phase 2: 生物システム（5種類） ✅
  - Phase 3: 環境の動的反応 ✅
  - Phase 4: インタラクション機能 ✅
  - **地表システム**: 地表平面と地上/地下の分離 ✅

## 🎯 設計目標

1. **生命感の演出**: 静的なオブジェクトではなく、成長・変化・相互作用する生態系
2. **発見の楽しさ**: 眺めていると新しい発見がある、飽きない体験
3. **感情との共鳴**: ユーザーの感情が環境に反映され、環境が感情に影響を与える循環
4. **没入感の向上**: 「秘密基地」のような、自分だけの特別な空間

---

## 🌱 機能1: 感情に応じた植物生態系

### 1.1 感情別の植物マッピング

各感情カテゴリの周囲に、その感情を象徴する植物が自然に生える。

| 感情 | 植物タイプ | 特徴 |
|------|-----------|------|
| **joy** | キラキラした花 | 明るい色、開花アニメーション、光を放つ |
| **peace** | 苔・シダ | ゆっくり成長、柔らかな動き、青緑色 |
| **stress** | トゲのある植物 | 鋭い形状、震える動き、赤・紫の色 |
| **sadness** | 透明な水草 | ゆっくり揺れる、透過、沈降する |
| **inspiration** | 発光する菌類 | 虹色に変化、脈動、回転する |
| **nostalgia** | 古い木の根 | セピア色、ゆっくり成長、浮遊 |
| **confusion** | 歪んだ植物 | 不規則な形状、不規則な動き、濁った緑 |

### 1.2 実装詳細

#### 植物の生成ルール
- 感情オブジェクトの周囲（半径2-5単位）にランダムに配置
- 感情の強度（strength）に応じて植物の数とサイズが変わる
- 時間の経過で徐々に成長（0.5倍 → 1.0倍のサイズに）
- 深度によって植物の種類が変化（浅い層は明るい植物、深い層は暗い植物）

#### 植物のアニメーション
- **成長アニメーション**: 生成時から1-3秒かけて成長
- **揺れ**: 微風のようなゆっくりとした揺れ（sin波ベース）
- **発光**: 感情の強度に応じた発光の強弱
- **開花**: joyやinspirationの植物は定期的に開花アニメーション

#### パフォーマンス最適化
- 視界範囲外の植物は描画しない（Frustum Culling）
- 遠くの植物は簡易形状（LOD）
- インスタンシングで同じ形状の植物をまとめて描画

---

## 🦋 機能2: 浮遊する小さな生物

### 2.1 生物の種類

感情の地層に住む、小さな光の生物たち。

| 生物タイプ | 特徴 | 出現条件 |
|-----------|------|---------|
| **光の蝶々** | joy/inspirationの周り | 明るい感情が多い深度 |
| **水の泡** | sadness/peaceの周り | 静かな感情が多い深度 |
| **エネルギーの粒** | stress/inspirationの周り | 強い感情の周り |
| **記憶の欠片** | nostalgiaの周り | 古い感情の周り |
| **迷子の光** | confusionの周り | 混乱した感情の周り |

### 2.2 実装詳細

#### 生物の行動パターン
- **群れ行動**: 同じタイプの生物が群れを作る
- **感情への反応**: 感情オブジェクトに引き寄せられる/反発する
- **遊泳パス**: ランダムウォーク + 感情オブジェクトへの引力
- **発光**: 感情の強度に応じて明るさが変わる

#### パフォーマンス
- パーティクルシステムを使用（GPU加速）
- 最大100-200個の生物を同時表示
- 深度に応じて生物の数を調整

---

## 🌊 機能3: 環境の動的反応

### 3.1 感情の影響による環境変化

#### 光の変化
- **joyが多い**: 環境が明るくなり、暖色の光が増える
- **sadnessが多い**: 環境が暗くなり、青い光が増える
- **stressが多い**: 光が点滅し、赤・紫の光が増える
- **peaceが多い**: 柔らかな光が広がり、環境が落ち着く

#### 霧の変化
- 感情の分布に応じて霧の密度が変わる
- 強い感情の周りでは霧が薄くなる（感情が「空間を切り開く」）
- 弱い感情が多い深度では霧が濃くなる

#### 背景色の微調整
- 現在の深度ベースの色に、感情の分布を反映
- 感情の平均的な色が背景色に少し混ざる

### 3.2 時間の経過による変化

#### 植物の成長
- 感情オブジェクトが生成されてから時間が経つと、周囲の植物が成長
- 古い感情（深い深度）ほど、植物が大きく成長している

#### 生態系の成熟
- 同じ深度に多くの感情があると、生態系が「成熟」する
- 成熟すると、より多様な生物が出現
- 植物同士がつながり、ネットワークのような構造が生まれる

---

## 🎨 機能4: インタラクティブな要素

### 4.1 オブジェクトとの相互作用

#### ホバー/タッチ反応
- 感情オブジェクトにマウスを近づけると、周囲の植物が光る
- タッチデバイスでは、タッチ位置に近いオブジェクトが反応

#### クリック/タップで詳細表示
- 感情オブジェクトをクリック/タップすると、詳細情報を表示
  - メッセージ内容（自分のもののみ）
  - 感情カテゴリと強度
  - 解析理由
  - 作成日時
  - 周囲の生態系の情報

#### 深度ジャンプ
- 特定の感情オブジェクトをクリックすると、その深度へスムーズに移動
- タイムライン表示で、時系列での感情の変化を可視化

### 4.2 環境との相互作用

#### 植物の反応
- カメラが近づくと、植物が「反応」して動く
- 感情オブジェクトの周囲の植物が、オブジェクトの動きに合わせて揺れる

#### 生物との相互作用
- 生物がカメラの周りを飛び回る
- カメラが動くと、生物が反応して逃げる/近づく

---

## 🌿 機能5: 生態系の循環と進化

### 5.1 感情の影響による生態系の変化

#### 感情の組み合わせ効果
- 異なる感情が近くにあると、新しいタイプの植物が生える
- 例: joy + peace → 明るい苔が生える
- 例: stress + sadness → 暗い水草が生える

#### 感情の強度による影響
- 強い感情（strength > 0.7）の周りには、より大きく・明るい植物が生える
- 弱い感情（strength < 0.3）の周りには、小さく控えめな植物が生える

### 5.2 時間による進化

#### 古い感情の変化
- 時間が経つと、感情オブジェクトの周囲の生態系が「成熟」する
- 植物が大きくなり、新しい生物が出現
- 感情の「記憶」が環境に刻まれる

#### 生態系の自己組織化
- 同じタイプの感情が集まると、そのエリアが「特化」する
- 例: joyが多いエリア → 明るい花園
- 例: sadnessが多いエリア → 静かな水の庭

---

## 🌍 機能5.5: 地表システム

### 5.5.1 地表平面の実装

#### 地表平面コンポーネント（SurfacePlane）
- **位置**: 深度0（y=0）に配置される半透明の平面
- **視覚的表現**:
  - カスタムシェーダーによるガラスモフィズム表現
  - フレネル効果（端がより明るく見える）
  - 時間ベースの微細な揺らぎ（水面のような効果）
  - カメラ位置に応じた透明度の動的調整
- **技術的詳細**:
  - Three.jsのShaderMaterialを使用
  - 透明度: 0.1（地上から見る）～ 0.8（地表付近）
  - サイズ: 200×200単位（十分に広い範囲をカバー）

### 5.5.2 地上と地下の明確な分離

#### 深度0付近での急激な視覚的変化
- **深度範囲**: -10 ～ 10（地表付近）
- **フォグ密度**:
  - 深度0: 0.0005（非常に薄い）
  - 深度10: 0.01（やや濃い）
  - 地上（深度 < 0）: さらに薄い（0.00025）
- **ライティング**:
  - 深度0: 最も明るい（ambient: +0.3, directional: +0.4）
  - 深度10: 通常の明るさ
  - 地上（深度 < 0）: さらに明るい（太陽光のような感じ）
- **背景色**:
  - 深度0: 最も明るい青空色（rgb(135, 206, 250)）
  - 深度10: やや暗い色（rgb(80, 100, 120)）
  - 地上（深度 < 0）: さらに明るい（rgb(180, 220, 255)）

#### 地上エリアと地下エリアの定義
- **地上エリア**: 深度 < 0
  - 明るい青空色の背景
  - 非常に薄いフォグ（空の霞のような感じ）
  - 明るいライティング（太陽光）
  - 感情オブジェクトは表示されない（地上には存在しない）
- **地下エリア**: 深度 > 0
  - 深い色の背景（深度が深いほど暗く）
  - 濃いフォグ（深度が深いほど濃く）
  - 暗いライティング（感情の分布に応じて変化）
  - 感情オブジェクトが表示される

### 5.5.3 深度インジケーターの拡張

#### 地表の位置表示
- **地表の位置**: 深度0を表示
- **現在の深度の状態表示**:
  - 「地上」（深度 < 0）: 青いインジケーター
  - 「地表」（深度0付近、±0.5以内）: シアンのインジケーター（点滅）
  - 「地下」（深度 > 0）: アンバーのインジケーター
- **地表からの距離表示**: 地表から離れている場合、距離と方向（↑/↓）を表示

### 5.5.4 深度マップへの「地上へ戻る」ボタン

#### 機能詳細
- **位置**: 深度マップのヘッダー部分（閉じるボタンの左側）
- **機能**: クリックで深度0（地上）にジャンプし、深度マップを閉じる
- **デザイン**:
  - シアン系の色（`bg-cyan-500/20`、`border-cyan-400/30`）
  - 上向き矢印アイコン
  - ガラスモフィズム（`backdrop-blur-sm`）
  - ホバー時の視覚的フィードバック

---

## 🎭 機能6: 季節・時間帯の演出

### 6.1 時間帯による変化

#### リアルタイムの時間反映
- ユーザーのローカル時間に応じて環境が変化
- **朝（6-12時）**: 明るい光、活発な生物
- **昼（12-18時）**: 最も明るい、植物が活発
- **夕方（18-21時）**: 暖色の光、ゆっくりした動き
- **夜（21-6時）**: 暗い光、発光する植物・生物が目立つ

### 6.2 季節感の演出（将来的に）

#### カレンダー連携
- 外部データ（カレンダー）から季節を取得
- 季節に応じて植物の色や種類が変わる
- 例: 春 → 明るい花、秋 → セピア色の葉

---

## 📐 実装アーキテクチャ

### コンポーネント構造

```
src/components/canvas/
├── Scene.tsx                    # メインシーン（既存）
├── SurfacePlane.tsx             # 地表平面（深度0、y=0に配置）
├── emotions/                    # 感情オブジェクト（既存）
│   └── ...
├── ecosystem/                   # 新規: 生態系コンポーネント
│   ├── PlantSystem.tsx         # 植物システム
│   ├── Plant.tsx               # 個別の植物コンポーネント
│   │   ├── JoyPlant.tsx
│   │   ├── PeacePlant.tsx
│   │   └── ...
│   ├── CreatureSystem.tsx      # 生物システム
│   ├── Creature.tsx            # 個別の生物コンポーネント
│   │   ├── LightButterfly.tsx
│   │   ├── WaterBubble.tsx
│   │   └── ...
│   └── EcosystemManager.tsx    # 生態系の管理
├── environment/                 # 新規: 環境要素
│   ├── DynamicLighting.tsx     # 動的ライティング
│   ├── AdaptiveFog.tsx         # 適応的フォグ
│   └── BackgroundGradient.tsx  # 背景グラデーション
└── interactions/                # 新規: インタラクション
    ├── EmotionDetailModal.tsx   # 感情詳細モーダル
    ├── DepthJumpButton.tsx      # 深度ジャンプ
    └── TimelineView.tsx         # タイムライン表示
```

### ストア構造

```typescript
// src/store/useEcosystemStore.ts
interface EcosystemStore {
  // 植物の状態
  plants: Plant[];
  addPlant: (plant: Omit<Plant, "id">) => void;
  removePlant: (id: string) => void;
  
  // 生物の状態
  creatures: Creature[];
  addCreature: (creature: Omit<Creature, "id">) => void;
  removeCreature: (id: string) => void;
  
  // 生態系の成熟度
  maturity: Map<number, number>; // depth -> maturity level
  updateMaturity: (depth: number, level: number) => void;
}
```

### パフォーマンス最適化戦略

1. **インスタンシング**: 同じ形状の植物をまとめて描画
2. **LOD (Level of Detail)**: 遠くの植物は簡易形状
3. **Frustum Culling**: 視界外の要素は描画しない
4. **パーティクルシステム**: 生物はGPU加速のパーティクルで
5. **デバウンス**: 環境変化の計算を間引く

---

## 🎨 デザイン原則

### 色調
- **ガラスモフィズム**: 透過、ぼかし、柔らかな発光
- **ネオン**: 明るい感情にはネオンカラー
- **パステル**: 静かな感情にはパステルカラー
- **深海の色調**: 深い深度には深い色

### アニメーション
- **緩急**: 感情に応じてアニメーションの速度を変える
  - joy: 速い、活発
  - peace: ゆっくり、滑らか
  - stress: 不規則、震える
- **イージング**: 自然な動き（ease-in-out、ease-out）

### 音（将来的に）
- 環境音: 植物の揺れる音、生物の羽音
- 感情に応じた音: 各感情カテゴリに特有の音

---

## 📊 実装フェーズ

### Phase 1: 基礎的な植物システム（優先度: 高）
- [ ] 感情別の植物コンポーネント作成
- [ ] 植物の生成ロジック実装
- [ ] 基本的な成長アニメーション
- [ ] パフォーマンス最適化（インスタンシング、LOD）

### Phase 2: 生物システム（優先度: 中）
- [ ] 生物コンポーネント作成
- [ ] パーティクルシステム実装
- [ ] 群れ行動の実装
- [ ] 感情への反応ロジック

### Phase 3: 環境の動的反応（優先度: 高）
- [ ] 動的ライティング実装
- [ ] 適応的フォグ実装
- [ ] 背景色の感情反映
- [ ] 時間の経過による変化

### Phase 4: インタラクション（優先度: 中）
- [ ] ホバー/タッチ反応
- [ ] 詳細表示モーダル
- [ ] 深度ジャンプ機能
- [ ] タイムライン表示

### Phase 5: 生態系の循環（優先度: 低）
- [ ] 感情の組み合わせ効果
- [ ] 生態系の成熟システム
- [ ] 自己組織化の実装

### Phase 6: 季節・時間帯（優先度: 低）
- [ ] 時間帯による環境変化
- [ ] カレンダー連携（将来的に）

---

## 🧪 テスト計画

### パフォーマンステスト
- 100個の感情オブジェクト + 500個の植物 + 200個の生物でのFPS測定
- モバイルデバイスでの動作確認
- メモリ使用量の監視

### ユーザーテスト
- テラリウム感の体感テスト
- インタラクションの使いやすさテスト
- 長時間眺めていて飽きないかテスト

---

## 📝 今後の拡張アイデア

1. **音の追加**: 環境音、感情に応じた音
2. **AR対応**: スマホのカメラで現実世界に重ねる
3. **共有機能**: 自分のテラリウムをスクリーンショットで共有
4. **カスタマイズ**: 植物の種類や色をユーザーが選べる
5. **AI生成**: Geminiで植物の形状や色を生成

---

## 🎯 成功指標

- **没入感**: ユーザーが5分以上眺め続けられる
- **発見**: 眺めていると新しい発見がある（植物の成長、生物の行動）
- **感情との共鳴**: 自分の感情が環境に反映されていると感じる
- **パフォーマンス**: 60FPSを維持（デスクトップ）、30FPS以上（モバイル）

---

## 🔍 設計確認・調整事項

### ✅ 1. 座標系とスケールの確認

#### 現在の実装状況（確認済み）
- **感情オブジェクトの配置範囲**: x, z座標は -5 から 5 の範囲（合計10単位）✅
- **感情オブジェクトのサイズ範囲**: 
  - 最小: 0.2単位（sadness, strength=0）
  - 最大: 0.65単位（nostalgia, strength=1）
  - 平均: 約0.3-0.5単位（strengthに応じて変化）✅
- **深度（y座標）**: マイナス方向が時間の深さ（depth: 0 = 地上、depth: 1000+ = 深淵）✅
- **カメラ位置**: y = -depth で深度に追従✅
- **Sparklesのスケール**: 100-400単位（環境要素として非常に大きい）✅

#### 植物配置の最終決定
- **植物の配置半径**: 感情オブジェクトの周囲 **半径1.5-3.0単位** に決定
  - 理由: 
    - 感情オブジェクトの配置範囲が10単位
    - 感情オブジェクトのサイズが0.2-0.65単位
    - 植物が重なりすぎず、かつ感情オブジェクトと視覚的に関連付けられる距離
- **植物のサイズ**: 感情オブジェクトの0.4-1.2倍のサイズ
  - 小さい植物: 0.08-0.24単位（感情オブジェクトの0.4倍）
  - 中程度の植物: 0.12-0.36単位（感情オブジェクトの0.6倍）
  - 大きい植物: 0.24-0.78単位（感情オブジェクトの1.2倍、強い感情の周り）
- **植物の数**: 感情オブジェクト1個あたり2-5個
  - strength < 0.3: 2個
  - 0.3 ≤ strength < 0.7: 3-4個
  - strength ≥ 0.7: 4-5個

### ✅ 2. パフォーマンス目標の再確認

#### 現在の実装（確認済み）
- **Sparkles**: 3層で合計450個のパーティクル ✅
- **感情オブジェクト**: 無制限（データベースから読み込む）✅
- **他者の光**: 深度±200の範囲でフィルタリング ✅

#### 植物システム追加時の目標（確定）
- **植物の最大数**: 感情オブジェクト1個あたり2-5個の植物
  - 100個の感情オブジェクト → 最大500個の植物
  - 50個の感情オブジェクト → 最大250個の植物
- **生物の最大数**: 深度範囲あたり100-200個
  - 現在の深度±500の範囲で表示
- **目標FPS**: 
  - **デスクトップ**: 60FPS（感情100個 + 植物500個 + 生物200個 + Sparkles 450個）
  - **モバイル**: 30FPS（感情50個 + 植物250個 + 生物100個 + Sparkles 300個）
- **メモリ使用量**: 
  - デスクトップ: 500MB以下
  - モバイル: 300MB以下

### ✅ 3. 実装優先順位の調整（確定）

#### Phase 1の詳細化（最優先・確定）
1. **最小限の植物システム**（MVP）
   - [ ] 1-2種類の植物コンポーネント（joy, peace）のみ実装
     - JoyPlant: キラキラした花、明るい色、開花アニメーション
     - PeacePlant: 苔・シダ、青緑色、ゆっくり成長
   - [ ] 基本的な生成ロジック（感情オブジェクトの周囲に配置）
     - 半径1.5-3.0単位の範囲
     - strengthに応じて2-5個生成
   - [ ] シンプルな成長アニメーション
     - 生成時から1-3秒かけて成長（0.5倍 → 1.0倍）
     - 微風のような揺れ（sin波ベース）
   - [ ] パフォーマンステスト
     - 50個の感情オブジェクト + 150個の植物でFPS測定

2. **段階的な拡張**（Phase 1.5）
   - [ ] 残りの植物タイプを追加（stress, sadness, inspiration, nostalgia, confusion）
   - [ ] アニメーションの改善（開花、発光の強化）
   - [ ] パフォーマンス最適化（Frustum Culling、インスタンシング）

#### Phase 3の優先度調整（確定）
- **環境の動的反応**は植物システムと並行して実装可能 ✅
- 動的ライティングは植物の見た目に直接影響するため、Phase 1と同時進行を推奨 ✅
- 実装順序:
  1. Phase 1: 植物システム（MVP）
  2. Phase 3（並行）: 動的ライティング（植物の見た目に影響）
  3. Phase 1.5: 植物システムの拡張
  4. Phase 3（続き）: 適応的フォグ、背景色の感情反映

### ✅ 4. 技術的な確認事項（確定）

#### 使用するライブラリ（確認済み）
- **植物の3D形状**: Three.jsの基本ジオメトリ + カスタム形状 ✅
  - 既存: `@react-three/drei` (v9.114.0) ✅
  - 既存: `three` (v0.169.0) ✅
- **パーティクルシステム**: @react-three/dreiの`Sparkles`を参考に、カスタムパーティクルシステム
  - または`@react-three/drei`の`Points`コンポーネントを使用
- **インスタンシング**: Three.jsの`InstancedMesh`を使用
  - React Three Fiberでは`<instancedMesh>`コンポーネント
- **LOD**: @react-three/dreiの`Detailed`コンポーネントまたはカスタム実装
  - `@react-three/drei`に`Detailed`コンポーネントが存在するか確認が必要

#### データ構造の検討（確定）
- **植物の永続化**: リアルタイム生成（感情オブジェクトから動的に生成）✅
  - 理由: 
    - データ量の削減（データベースに保存しない）
    - 柔軟な配置調整が可能
    - 感情オブジェクトの変更に即座に反映
- **植物の生成タイミング**: 
  - 感情オブジェクトが追加された時
  - シーンが読み込まれた時（既存の感情オブジェクトから生成）
- **植物の削除タイミング**: 
  - 感情オブジェクトが削除された時
  - 視界外に移動した時（オプション: メモリ節約のため）

#### パフォーマンス最適化の実装順序（確定）
1. **Frustum Culling**: 最初に実装（最も効果的）
   - カメラの視界範囲外の植物を描画しない
   - 深度±500の範囲でフィルタリング（既存の他者の光と同じロジック）
2. **インスタンシング**: 同じ形状の植物をまとめて描画
   - 同じタイプの植物（例: すべてのJoyPlant）を1つのInstancedMeshで描画
3. **LOD**: 遠くの植物は簡易形状
   - 距離に応じてジオメトリの詳細度を変更
   - または遠くの植物は非表示
4. **デバウンス**: 環境変化の計算を間引く
   - 植物の生成・削除をバッチ処理
   - アニメーションの更新頻度を調整

### ✅ 5. デザインの調整案（確定）

#### 植物の視覚的バランス（確定）
- **感情オブジェクトとのサイズ比**: 植物は感情オブジェクトの0.4-1.2倍 ✅
  - 小さい植物: 0.4倍（控えめな存在感）
  - 中程度の植物: 0.6倍（バランスの取れたサイズ）
  - 大きい植物: 1.2倍（強い感情の周り、目立つ存在）
- **色の調和**: 植物の色は感情オブジェクトの色と調和させる
  - **類似色**: 感情オブジェクトの色に近い色（例: joyのゴールド → 黄色い花）
  - **補色**: 感情オブジェクトの色の補色（例: peaceの青緑 → 青緑の苔）
  - **明度調整**: 植物の色は感情オブジェクトより少し暗め（0.7-0.9倍の明度）
- **発光の強度**: 植物の発光は感情オブジェクトより控えめ（0.3-0.6倍）✅
  - 感情オブジェクト: emissiveIntensity 0.4-1.0
  - 植物: emissiveIntensity 0.12-0.6（感情オブジェクトの0.3-0.6倍）

#### アニメーションの統一感（確定）
- **成長速度**: 感情の強度に応じて変化（強い感情 → 速い成長）✅
  - strength < 0.3: 3秒かけて成長
  - 0.3 ≤ strength < 0.7: 2秒かけて成長
  - strength ≥ 0.7: 1秒かけて成長
- **揺れの同期**: 同じ深度の植物は同じリズムで揺れる（微風の効果）✅
  - 深度をシード値として使用: `sin(time + depth * 0.1)`
  - 同じ深度の植物は同じ位相で揺れる
- **開花アニメーション**: joyとinspirationの植物のみ
  - 3-5秒ごとに開花（スケールが1.0 → 1.2 → 1.0）
  - 開花時に発光が強くなる（emissiveIntensity 0.6 → 1.0 → 0.6）

### ✅ 6. 実装時の注意点（確定）

#### メモリ管理（確定）
- **植物オブジェクトは感情オブジェクトのライフサイクルに連動** ✅
  - 感情オブジェクトが追加された時: 植物を生成
  - 感情オブジェクトが削除された時: 関連する植物も削除
- **視界外の植物の処理**:
  - オプション1: メモリから解放（ガベージコレクション）
  - オプション2: メモリに保持（再表示が速い）
  - **推奨**: オプション2（感情オブジェクトが削除されない限り保持）
- **メモリリークの防止**:
  - React Three Fiberのコンポーネントは自動的にクリーンアップされる
  - カスタムイベントリスナーやタイマーは必ずクリーンアップ

#### 座標の一貫性（確定）
- **植物の位置は感情オブジェクトの位置を基準に相対的に配置** ✅
  - 感情オブジェクトの位置: `[emotion.x, -emotion.depth, emotion.z]`
  - 植物の位置: `[emotion.x + offsetX, -emotion.depth, emotion.z + offsetZ]`
  - offsetX, offsetZ: 半径1.5-3.0単位の範囲でランダム
- **感情オブジェクトが移動した場合**: 
  - 現状は固定位置（感情オブジェクトは移動しない）✅
  - 将来的に感情オブジェクトが移動する場合は、植物も追従する必要がある

#### デバッグ機能（確定）
- **開発環境での可視化**:
  - 植物の生成範囲を可視化（ワイヤーフレーム表示）
  - 感情オブジェクトと植物の関係を線で表示（オプション）
- **パフォーマンスモニタリング**:
  - FPS表示（React Three Fiberの`Stats`コンポーネント）
  - 描画オブジェクト数の表示
  - メモリ使用量の表示（オプション）
- **開発用コマンド**:
  - 植物の生成/削除を手動で制御
  - パフォーマンステスト用の大量データ生成

---

## 📝 変更履歴

| 日時 | バージョン | 変更内容 |
|------|----------|---------|
| 2024年12月30日 | 1.0 | 初版作成 |
| 2024年12月30日 | 1.1 | 設計確認・調整事項を追加、座標系とスケールを確認 |
| 2024年12月30日 | 1.2 | 全6項目の確認完了、実装仕様を確定 |

---

## ✅ 確認完了サマリー

### 確認完了項目
1. ✅ **座標系とスケール**: 感情オブジェクトのサイズ範囲（0.2-0.65単位）を確認、植物の配置半径を1.5-3.0単位に確定
2. ✅ **パフォーマンス目標**: 現在の実装（Sparkles 450個）を確認、目標FPSとメモリ使用量を設定
3. ✅ **実装優先順位**: Phase 1のMVPを詳細化、Phase 3との並行実装を確定
4. ✅ **技術的な確認**: 使用ライブラリを確認、データ構造（リアルタイム生成）を確定、最適化順序を決定
5. ✅ **デザインの調整**: サイズ比・色の調和・発光強度を数値化、アニメーションの詳細を決定
6. ✅ **実装時の注意点**: メモリ管理・座標の一貫性・デバッグ機能を確定

### 次のステップ
- Phase 1（MVP）の実装開始準備完了
- 実装開始前に、技術的な詳細設計（各コンポーネントのインターフェース定義）を推奨

---

**作成日**: 2024年12月30日
**最終更新日**: 2024年12月30日
**バージョン**: 1.3
**ステータス**: 設計確定・実装完了（地表システム追加）

