# 次の実装計画

## 📊 現在の実装状況

### ✅ 実装済み機能
1. **感情オブジェクトのインタラクション** - ホバー/クリック検出、モーダル表示
2. **基本的な背景色と地面の描画** - 深度に応じた背景色と地面のスクロール
3. **感情オブジェクトの2D表示** - PixiJSを使用したドット絵スタイル
4. **他者の光の基本表示** - 基本的な光の描画
5. **星屑エフェクト（Sparkles）** - 複数レイヤーの星屑パーティクル

### ❌ 未実装機能
1. **他者の光の点滅アニメーション** - 点滅効果が未実装
2. **背景色への感情分布の影響** - 感情が環境に反映されない
3. **地上エリアと地下エリアの判定と処理分岐** - エリア判定ロジックが未実装
4. **植物システム** - 感情オブジェクトから植物が生える機能
5. **生物システム** - 感情オブジェクトから生物が生える機能

---

## 🎯 推奨実装順序

### Phase 1: 視覚的フィードバックの向上（優先度: 高）

#### 1. 他者の光の点滅アニメーション ⭐ **最優先推奨**
**実装難易度**: 低  
**視覚的効果**: 中  
**ユーザー体験への影響**: 中  
**実装時間**: 1-2時間

**理由**:
- 既存の実装にアニメーションを追加するだけなので実装が簡単
- 他者の存在をより明確に示すことができる
- すぐに視覚的な改善が感じられる

**実装内容**:
- PixiJSの`Ticker`を使用した点滅アニメーション
- 0.5秒周期のパルス効果（不透明度0.4〜0.8）
- 各光の個別アニメーション管理

**実装場所**:
- `src/components/canvas/Scene2DPixi.tsx` の他者の光描画部分（386-420行目）

**期待される効果**:
- 他者の存在がより視覚的に分かりやすくなる
- 空間に生命感を追加
- 「秘密基地」の雰囲気を強化

---

### Phase 2: 核心機能の実現（優先度: 高）

#### 2. 背景色への感情分布の影響
**実装難易度**: 中  
**視覚的効果**: 高  
**ユーザー体験への影響**: 高  
**実装時間**: 3-4時間

**理由**:
- プロジェクトの核心機能「感情が環境に影響を与える」を実現
- ユーザーの感情が視覚的に反映されることで、没入感が向上
- 3D版のロジックを2Dに適応可能

**実装内容**:
- 感情分布の分析関数（`analyzeEmotionDistribution`）を実装
- 背景色計算に感情の影響を追加（10%程度）
- 感情タイプごとの色の影響:
  - `joy`/`inspiration`: 暖色（黄色・オレンジ）の影響
  - `sadness`/`peace`: 青緑色の影響
  - `stress`: 赤・紫の影響
  - `nostalgia`: セピア色の影響
  - `confusion`: 濁った緑の影響
- 白っぽい色にならないように制限（r, g, b がすべて150以上にならない）

**実装場所**:
- `src/components/canvas/Scene2DPixi.tsx` の背景色計算部分
- 新規ファイル: `src/lib/utils/emotionAnalysis.ts`（感情分布分析関数）

**期待される効果**:
- ユーザーの感情が空間に反映される感覚
- よりパーソナルな体験
- 感情の可視化がより明確に

---

#### 3. 地上エリアと地下エリアの判定と処理分岐
**実装難易度**: 中  
**視覚的効果**: 中  
**ユーザー体験への影響**: 高  
**実装時間**: 2-3時間

**理由**:
- 地上と地下で異なる体験を提供できる
- 感情分布の分析方法を最適化
- 将来的な機能拡張の基盤

**実装内容**:
- `isSurfaceArea`判定の実装（深度0-100が地上、100より大きい値が地下）
- 地上エリア: 全感情オブジェクトの分布を分析
- 地下エリア: 近くの感情オブジェクトのみを分析（±800の範囲）
- エリアに応じた背景色やエフェクトの調整
- 地上エリアでは明るい背景、地下エリアでは暗い背景

**実装場所**:
- `src/components/canvas/Scene2DPixi.tsx` の背景色計算と感情分布分析部分

**期待される効果**:
- 地上と地下で異なる雰囲気を演出
- より構造化された体験
- 深度による体験の変化が明確に

---

### Phase 3: エコシステムの追加（優先度: 中）

#### 4. 植物システム（PlantSystem）
**実装難易度**: 高  
**視覚的効果**: 高  
**ユーザー体験への影響**: 中  
**実装時間**: 1-2週間

**理由**:
- 感情オブジェクトから植物が生えるという動的な要素
- 空間に生命感と成長の感覚を追加
- ただし、実装が複雑

**実装内容**:
- 感情オブジェクトの周囲に植物を生成
- 感情タイプごとの専用植物スプライト（2Dドット絵）
- 成長アニメーション
- 地上/地下エリアでの配置ロジック

---

#### 5. 生物システム（CreatureSystem）
**実装難易度**: 高  
**視覚的効果**: 高  
**ユーザー体験への影響**: 中  
**実装時間**: 1-2週間

**理由**:
- 植物システムと同様に動的な要素を追加
- ただし、実装が最も複雑

**実装内容**:
- 感情オブジェクトの周囲に生物を生成
- 感情タイプごとの専用生物スプライト（2Dドット絵）
- 移動アニメーション

---

## 📋 実装しない方が良い機能（2D版では効果が限定的）

以下の機能は、2D版では視覚的な効果が限定的なため、優先度を下げることを推奨します：

1. **フォグ（Fog）システム** - 2Dでは視覚的な効果が限定的
2. **ライティングシステム** - 背景色の調整で代替可能
3. **地表平面（SurfacePlane）** - 2Dでは視覚的な分離が限定的
4. **カメラ制御** - 2Dでは不要
5. **テラリウム（Terrarium）** - 地上エリア専用で、優先度が低い

---

## 🚀 次のステップ

### 即座に実装を開始すべき機能

**1. 他者の光の点滅アニメーション** ⭐ **最優先**

理由:
- 実装が簡単（1-2時間）
- すぐに視覚的な改善が感じられる
- 他者の存在をより明確に示せる

実装方法:
1. `Scene2DPixi.tsx`の他者の光描画部分（386-420行目）を修正
2. PixiJSの`Ticker`を使用して不透明度をアニメーション
3. 各光の個別アニメーション管理

### 次に実装すべき機能

**2. 背景色への感情分布の影響**

理由:
- プロジェクトの核心機能
- ユーザーの感情が視覚的に反映される
- 没入感が大幅に向上

実装方法:
1. 感情分布分析関数を作成
2. 背景色計算に感情の影響を追加
3. 感情タイプごとの色の影響を実装

---

## 💡 実装時の注意点

1. **パフォーマンス**: アニメーションやパーティクルは数が多いと重くなるため、適切な制限を設ける
2. **視覚的な一貫性**: 2Dドット絵のスタイルを維持する
3. **段階的な実装**: 一度にすべてを実装せず、一つずつ実装して動作確認する
4. **テスト**: 各機能を実装したら、必ず動作確認を行う

---

## 📝 実装チェックリスト

### Phase 1: 視覚的フィードバックの向上
- [ ] 他者の光の点滅アニメーション
  - [ ] PixiJSの`Ticker`を使用したアニメーション実装
  - [ ] 0.5秒周期のパルス効果
  - [ ] 不透明度のアニメーション（0.4〜0.8）
  - [ ] 動作確認

### Phase 2: 核心機能の実現
- [ ] 背景色への感情分布の影響
  - [ ] 感情分布分析関数の実装
  - [ ] 背景色計算への感情影響の追加
  - [ ] 感情タイプごとの色の影響
  - [ ] 動作確認
- [ ] 地上エリアと地下エリアの判定と処理分岐
  - [ ] `isSurfaceArea`判定の実装
  - [ ] エリアに応じた感情分布分析の分岐
  - [ ] エリアに応じた背景色の調整
  - [ ] 動作確認

### Phase 3: エコシステムの追加
- [ ] 植物システム（将来実装）
- [ ] 生物システム（将来実装）

---

## 🎯 まとめ

**次の実装**: **他者の光の点滅アニメーション**

この機能は:
- ✅ 実装が簡単（1-2時間）
- ✅ すぐに視覚的な改善が感じられる
- ✅ 他者の存在をより明確に示せる
- ✅ 空間に生命感を追加

実装を開始する準備ができています！

